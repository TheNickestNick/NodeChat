<html>
	<head>
		<title>Welcome to NodeChat!</title>
		<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<style type="text/css">
			#chatroom {
				display: none;
			}
			
			#messages {
				height: 600px;
				overflow: auto;
			}
						
			#send input[type='text'] {
				width: 300px;
			}
						
			.message .username {
				width: 100px;
				display: inline-block;
			}
			
			.message .text {
				display: inline-block;
			}
		</style>
	</head>
	<body>
		<script type="text/javascript">
			var connectedAs, socket;
			
			$(function() {
				$('#username-input').focus(function(){ $('#username-input').val('')});
			
				$('#connect').click(function() {
					var username = $('#username-input').val();
					
					if (!username) {
						alert('You must enter a username.');
					}
					else {
						connect(username);
					}
				});
				
				$('#send').submit(function(evt) {
					socket.emit('chat-message', { username: connectedAs, text: $('#text').val()})
					$('#text').val('');
					evt.preventDefault();
				});
			});
			
			function connect(username) {
				$('#login').hide();
				$('#chatroom').show();
				$('#username-display em').text(username);
				connectedAs = username;
				
				socket = io.connect('/');
				socket.on('chat-message', appendMessage);
			}
			
			function appendMessage(message) {
				var color = stringToColor(message.username);
				var el = $(
					  '<div class="message">'
					+   '<div class="username" style="color:' + color + '">'
					+ 	  message.username 
					+   '</div>'
					+   '<div class="text">' 
					+ 	  message.text 
					+   '</div>'
					+ '</div>');
				$('#messages').append(el);
			}
			
			function stringToColor(username) {
				return '#' + (Math.abs(hash(username)).toString(16) + '000000').substr(0, 6);
			}

			function hash(str){
				var h = 0, i, c;
				if (str.length == 0) return h;
				for (i = 0; i < str.length; i++) {
					c = str.charCodeAt(i);
					h = ((h<<5)-h)+c;
					h = h & h; // Convert to 32bit integer
				}
				return h;
			};
		</script>
		
		<h1>NodeChat</h1>
		<div id="login">
			<p>
				Enter a username below and click "connect" to begin chatting!
			</p>
			<input type="text" id="username-input" value="username" />
			<button type="button" id="connect">connect</button>
		</div>
		<div id="chatroom">
			<p id="username-display">
				connected as <em></em>
			</p>
			<div id="messages">
			
			</div>
			<form id="send">
				<input type="text" value="" id="text" name="text" />
				<button type="submit">send</button>
			</form>
		</div>
	</body>
</html>